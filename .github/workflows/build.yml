name: Build Resume

on:
  push:
    tags:
      - '*-*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Parse tag
        id: tag
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          
          IFS='-' read -r VARIANT DATE REV <<< "$TAG"
          
          if [[ -z "$VARIANT" || -z "$DATE" || -z "$REV" ]]; then
            echo "Invalid tag format: $TAG"
            echo "Expected: <variant>-<YYYYMMDD>-v<rev>"
            exit 1
          fi
          
          if [[ ! "$DATE" =~ ^[0-9]{8}$ ]]; then
            echo "Invalid date format: $DATE (expected YYYYMMDD)"
            exit 1
          fi
          
          if [[ ! "$REV" =~ ^v[0-9]+$ ]]; then
            echo "Invalid revision format: $REV (expected vN)"
            exit 1
          fi
          
          echo "variant=$VARIANT" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "revision=$REV" >> $GITHUB_OUTPUT
          
          echo "Detected variant : $VARIANT"
          echo "Detected date    : $DATE"
          echo "Detected revision: $REV"

      - name: Compile Resume
        run: |
          VARIANT=${{ steps.tag.outputs.variant }}
          
          docker build -t resume-builder .
          docker run --rm \
            -v $PWD:/work \
            -e TEXINPUTS=cls: \
            resume-builder \
            xelatex -interaction=nonstopmode variants/developer/resume.tex

      - name: Upload PDF
        uses: actions/upload-artifact@v4
        with:
          name: resume-${{ steps.tag.outputs.variant }}-${{ steps.tag.outputs.date }}-${{ steps.tag.outputs.revision }}
          path: resume-*.pdf
